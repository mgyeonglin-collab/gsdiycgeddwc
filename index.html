<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TrashTrade â€” Production-ready (Local)</title>
<link href="https://fonts.googleapis.com/css2?family=Gowun+Batang&display=swap" rel="stylesheet">
<style>
:root{
  --main-green:#6BA368;
  --light-green:#A1C181;
  --ivory:#F7F4EA;
  --accent-yellow:#F9CC66;
  --text-dark:#2B2B2B;
  --muted:#6f6f6f;
  --card-shadow: 0 6px 18px rgba(0,0,0,0.06);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:'Gowun Batang',serif;
  background:var(--ivory) url('https://www.transparenttextures.com/patterns/paper-fibers.png');
  color:var(--text-dark);
  -webkit-font-smoothing:antialiased;
  line-height:1.45;
  padding-bottom:80px;
}

/* Header */
.header{
  display:flex;align-items:center;justify-content:space-between;padding:14px 22px;background:var(--light-green);
  color:#fff;border-bottom:3px solid var(--main-green);
}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--main-green),var(--light-green));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
.header-actions{display:flex;gap:10px;align-items:center}
.btn{background:var(--accent-yellow);border:none;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
.icon-btn{background:transparent;border:none;color:#fff;cursor:pointer;font-weight:700;padding:8px}

/* Layout */
.container{max-width:1100px;margin:18px auto;padding:0 18px}
.hero{background:#fff;border-radius:14px;padding:20px;margin:16px 0;box-shadow:var(--card-shadow);text-align:center}
.hero h2{color:var(--main-green);font-size:24px;margin-bottom:8px}
.controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:14px}
.controls input,.controls select{padding:8px 10px;border-radius:10px;border:1px solid #e6e6e6}

/* Grid / Cards */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;max-width:1100px;margin:0 auto}
.card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:var(--card-shadow);display:flex;flex-direction:column;transition:transform .15s}
.card:hover{transform:translateY(-6px)}
.card img{width:100%;height:160px;object-fit:cover;background:#f3f3f3}
.card-content{padding:12px;display:flex;flex-direction:column;gap:8px}
.card-content h3{color:var(--main-green);font-size:17px}
.card-content p{color:#444;font-size:14px;min-height:44px}
.card-footer{display:flex;justify-content:space-between;align-items:center;margin-top:auto}
.tag{background:var(--light-green);color:#fff;padding:6px 10px;border-radius:8px;font-size:13px}
.exchange-btn{background:var(--main-green);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}

/* Panel (right) */
.panel-toggle{position:fixed;right:18px;top:96px;width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--main-green),var(--light-green));color:#fff;border:none;cursor:pointer;z-index:60}
.panel{position:fixed;right:-380px;top:0;width:360px;height:100%;background:#fff;box-shadow:-8px 0 30px rgba(0,0,0,0.12);padding:16px;transition:right .35s;z-index:59;overflow:auto}
.panel.open{right:0}
.section{margin-bottom:14px;padding-bottom:12px;border-bottom:1px dashed #f0f0f0}
.profile-row{display:flex;align-items:center;gap:10px}
.avatar{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--main-green),var(--light-green));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
.small{font-size:13px;color:var(--muted)}
.chat-list{max-height:220px;overflow:auto}
.chat-item{padding:8px;border-radius:8px;border:1px solid #f0f0f0;margin-bottom:8px;cursor:pointer}
.chat-item:hover{background:#fafafa}

/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:70}
.modal{background:#fff;border-radius:12px;padding:16px;max-width:820px;width:100%;max-height:90vh;overflow:auto}
.form-row{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}
.form-row input[type="text"],.form-row textarea,.form-row select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e6e6}
.form-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
.preview{width:140px;height:100px;border-radius:8px;background:#f3f3f3;display:flex;align-items:center;justify-content:center;color:#999}

/* Footer fixed actions */
.footer-actions{position:fixed;left:18px;bottom:18px;z-index:60;display:flex;flex-direction:column;gap:8px}

/* Responsive */
@media(max-width:900px){ .grid{grid-template-columns:repeat(2,1fr)} .panel{width:320px} .panel.open{right:0} .panel-toggle{right:12px} }
@media(max-width:600px){ .grid{grid-template-columns:repeat(1,1fr)} .panel{width:100%;right:-100%} .panel.open{right:0} .panel-toggle{display:none} }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="brand">
    <div class="logo">TT</div>
    <div>
      <div style="font-weight:800;font-size:18px">TrashTrade ğŸŒ¿</div>
      <div class="small">ì§€ì—­ ê¸°ë°˜ ìì› êµí™˜ â€” ì‹¤ì‚¬ìš© ë¡œì»¬ ë²„ì „</div>
    </div>
  </div>
  <div class="header-actions">
    <button id="openRegisterBtn" class="btn">ë¬¼í’ˆ ë“±ë¡</button>
    <button id="openChallenges" class="btn">ì±Œë¦°ì§€</button>
    <button id="openProfileBtn" class="btn">ë‚´ í™œë™</button>
    <button id="panelToggle" class="panel-toggle" title="ì‚¬ì´ë“œ íŒ¨ë„ ì—´ê¸°">â˜°</button>
  </div>
</div>

<div class="container">
  <section class="hero">
    <h2>ë‹¤ì‹œ ì“°ëŠ” ê¸°ì¨, ì§€êµ¬ì™€ í•¨ê»˜ ğŸŒ</h2>
    <p class="small">íšŒì›ê°€ì… í›„ ë¬¼í’ˆì„ ë“±ë¡í•˜ê³  êµí™˜í•˜ì„¸ìš”. ëª¨ë“  ë™ì‘ì€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì–´ ë°”ë¡œ ì‘ë™í•©ë‹ˆë‹¤.</p>
  </section>

  <div class="controls">
    <input id="searchInput" placeholder="ë¬¼í’ˆëª… ë˜ëŠ” ì„¤ëª… ê²€ìƒ‰">
    <select id="categoryFilter">
      <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
      <option value="ì±…">ì±…</option>
      <option value="ì˜ë¥˜">ì˜ë¥˜</option>
      <option value="ì „ìê¸°ê¸°">ì „ìê¸°ê¸°</option>
      <option value="ê¸°íƒ€">ê¸°íƒ€</option>
    </select>
    <select id="sidoSelect"><option value="">ì‹œÂ·ë„ ì„ íƒ</option></select>
    <select id="sigunSelect"><option value="">ì‹œÂ·êµ°Â·êµ¬ ì„ íƒ</option></select>
  </div>

  <div id="grid" class="grid" aria-live="polite"></div>

  <div id="dashboardArea"></div>
</div>

<!-- Panel -->
<button id="panelToggleBtn" class="panel-toggle" style="right:86px;top:96px">âš™</button>
<div id="panel" class="panel" aria-hidden="true">
  <div class="section">
    <div class="profile-row">
      <div class="avatar" id="avatar">?</div>
      <div>
        <div id="profileName" style="font-weight:800">ë¹„ë¡œê·¸ì¸</div>
        <div id="profileSchool" class="small">í•™êµ/ì§€ì—­ ì…ë ¥ í•„ìš”</div>
        <div class="small">í¬ì¸íŠ¸: <span id="profilePoints">0</span> Â· êµí™˜: <span id="profileTrades">0</span></div>
      </div>
    </div>
  </div>

  <div class="section">
    <h4>ì•Œë¦¼</h4>
    <div id="notifList" style="max-height:180px;overflow:auto"></div>
  </div>

  <div class="section">
    <h4>ì±„íŒ…</h4>
    <div id="chatList" class="chat-list"></div>
  </div>

  <div class="section">
    <h4>í¬ì¸íŠ¸ ìƒì </h4>
    <div id="shopList"></div>
  </div>

  <div class="section">
    <h4>ë­í‚¹ (í¬ì¸íŠ¸ ê¸°ì¤€)</h4>
    <div id="rankingList"></div>
  </div>
</div>

<!-- Modal backdrop -->
<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
  <div id="modal" class="modal"></div>
</div>

<!-- Footer quick actions -->
<div class="footer-actions">
  <button class="btn" id="openShopQuick">ìƒì  ë³´ê¸°</button>
  <button class="btn" id="openDashboardQuick">ëŒ€ì‹œë³´ë“œ</button>
</div>

<script>
/* ---------------- Storage keys & helpers ---------------- */
const K = {
  USERS: 'tt_users_vfinal',
  ITEMS: 'tt_items_vfinal',
  REQS: 'tt_reqs_vfinal',
  CHATS: 'tt_chats_vfinal',
  PURCHASES: 'tt_purchases_vfinal',
  CHALLENGES: 'tt_challenges_vfinal'
};
function uid(pref='id'){ return pref + '_' + Math.random().toString(36).slice(2,9); }
function load(key){ return JSON.parse(localStorage.getItem(key) || '[]'); }
function save(key, data){ localStorage.setItem(key, JSON.stringify(data)); }

/* ---------------- Carbon calc model ---------------- */
function calcCarbon(category, condition){
  const base = {'ì±…':1.5,'ì˜ë¥˜':6,'ì „ìê¸°ê¸°':40,'ê¸°íƒ€':3};
  const condMul = {'ìµœìƒ':1,'ì¢‹ìŒ':0.9,'ë³´í†µ':0.75,'ë‚¡ìŒ':0.5};
  return +(((base[category] || 3) * (condMul[condition] || 0.75)).toFixed(2));
}

/* ---------------- Region data (ì‹œÂ·ë„ -> ì‹œÂ·êµ°Â·êµ¬) ---------------- */
const REGION = {
  'ì„œìš¸íŠ¹ë³„ì‹œ': ['ê°•ë‚¨êµ¬','ê°•ë™êµ¬','ê°•ë¶êµ¬','ê°•ì„œêµ¬','ê´€ì•…êµ¬','ê´‘ì§„êµ¬','êµ¬ë¡œêµ¬','ê¸ˆì²œêµ¬','ë…¸ì›êµ¬','ë„ë´‰êµ¬','ë™ëŒ€ë¬¸êµ¬','ë™ì‘êµ¬','ë§ˆí¬êµ¬','ì„œëŒ€ë¬¸êµ¬','ì„œì´ˆêµ¬','ì„±ë™êµ¬','ì„±ë¶êµ¬','ì†¡íŒŒêµ¬','ì–‘ì²œêµ¬','ì˜ë“±í¬êµ¬','ìš©ì‚°êµ¬','ì€í‰êµ¬','ì¢…ë¡œêµ¬','ì¤‘êµ¬','ì¤‘ë‘êµ¬'],
  'ë¶€ì‚°ê´‘ì—­ì‹œ': ['ê°•ì„œêµ¬','ê¸ˆì •êµ¬','ê¸°ì¥êµ°','ë‚¨êµ¬','ë™êµ¬','ë™ë˜êµ¬','ë¶€ì‚°ì§„êµ¬','ë¶êµ¬','ì‚¬ìƒêµ¬','ì‚¬í•˜êµ¬','ì„œêµ¬','ìˆ˜ì˜êµ¬','ì—°ì œêµ¬','ì˜ë„êµ¬','ì¤‘êµ¬'],
  'ëŒ€êµ¬ê´‘ì—­ì‹œ': ['ë‚¨êµ¬','ë‹¬ì„œêµ¬','ë‹¬ì„±êµ°','ë™êµ¬','ë¶êµ¬','ì„œêµ¬','ìˆ˜ì„±êµ¬','ì¤‘êµ¬'],
  'ì¸ì²œê´‘ì—­ì‹œ': ['ê°•í™”êµ°','ê³„ì–‘êµ¬','ë¯¸ì¶”í™€êµ¬','ë‚¨ë™êµ¬','ë™êµ¬','ë¶€í‰êµ¬','ì„œêµ¬','ì—°ìˆ˜êµ¬','ì˜¹ì§„êµ°'],
  'ê´‘ì£¼ê´‘ì—­ì‹œ': ['ê´‘ì‚°êµ¬','ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬','ì„œêµ¬'],
  'ëŒ€ì „ê´‘ì—­ì‹œ': ['ëŒ€ë•êµ¬','ë™êµ¬','ì„œêµ¬','ìœ ì„±êµ¬','ì¤‘êµ¬'],
  'ìš¸ì‚°ê´‘ì—­ì‹œ': ['ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬','ìš¸ì£¼êµ°','ì¤‘êµ¬'],
  'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ': ['ì„¸ì¢…ì‹œ'],
  'ê²½ê¸°ë„': ['ìˆ˜ì›ì‹œ','ì„±ë‚¨ì‹œ','ê³ ì–‘ì‹œ','ìš©ì¸ì‹œ','ë¶€ì²œì‹œ','í™”ì„±ì‹œ','ë‚¨ì–‘ì£¼ì‹œ','ì•ˆì‚°ì‹œ','ì•ˆì–‘ì‹œ','í‰íƒì‹œ','ì˜ì •ë¶€ì‹œ','ì‹œí¥ì‹œ','íŒŒì£¼ì‹œ','ê´‘ëª…ì‹œ','ê¹€í¬ì‹œ','ê´‘ì£¼ì‹œ','í•˜ë‚¨ì‹œ','ì´ì²œì‹œ','ì–‘ì£¼ì‹œ','ì˜¤ì‚°ì‹œ','êµ¬ë¦¬ì‹œ','êµ°í¬ì‹œ','ì–‘í‰êµ°','ì—°ì²œêµ°','ì—¬ì£¼ì‹œ','ê°€í‰êµ°','í¬ì²œì‹œ'],
  'ê°•ì›ë„': ['ê°•ë¦‰ì‹œ','ê³ ì„±êµ°','ë™í•´ì‹œ','ì‚¼ì²™ì‹œ','ì†ì´ˆì‹œ','ì–‘êµ¬êµ°','ì–‘ì–‘êµ°','ì˜ì›”êµ°','ì›ì£¼ì‹œ','ì¸ì œêµ°','ì¶˜ì²œì‹œ','íƒœë°±ì‹œ','í‰ì°½êµ°','í™ì²œêµ°','í™”ì²œêµ°','íš¡ì„±êµ°'],
  'ì¶©ì²­ë¶ë„': ['ì²­ì£¼ì‹œ','ì¶©ì£¼ì‹œ','ì œì²œì‹œ','ë³´ì€êµ°','ì˜¥ì²œêµ°','ì˜ë™êµ°','ì§„ì²œêµ°','ê´´ì‚°êµ°','ìŒì„±êµ°','ë‹¨ì–‘êµ°'],
  'ì¶©ì²­ë‚¨ë„': ['ì²œì•ˆì‹œ','ê³µì£¼ì‹œ','ë³´ë ¹ì‹œ','ì•„ì‚°ì‹œ','ì„œì‚°ì‹œ','ë…¼ì‚°ì‹œ','ê³„ë£¡ì‹œ','ë‹¹ì§„ì‹œ','ê¸ˆì‚°êµ°','ë¶€ì—¬êµ°','ì„œì²œêµ°','ì²­ì–‘êµ°','íƒœì•ˆêµ°','í™ì„±êµ°'],
  'ì „ë¼ë¶ë„': ['ì „ì£¼ì‹œ','êµ°ì‚°ì‹œ','ìµì‚°ì‹œ','ì •ìì‹œ','ë‚¨ì›ì‹œ','ê¹€ì œì‹œ','ì™„ì£¼êµ°','ì§„ì•ˆêµ°','ë¬´ì£¼êµ°','ì¥ìˆ˜êµ°','ì„ì‹¤êµ°','ìˆœì°½êµ°','ê³ ì°½êµ°','ë¶€ì•ˆêµ°'],
  'ì „ë¼ë‚¨ë„': ['ëª©í¬ì‹œ','ì—¬ìˆ˜ì‹œ','ìˆœì²œì‹œ','ë‚˜ì£¼ì‹œ','ê´‘ì–‘ì‹œ','ë¬´ì•ˆêµ°','ì˜ì•”êµ°','ì‹ ì•ˆêµ°','í™”ìˆœêµ°','ê³ í¥êµ°','ì¥í¥êµ°','ê°•ì§„êµ°','í•´ë‚¨êµ°','ì™„ë„êµ°','ë³´ì„±êµ°','ê³¡ì„±êµ°','ë‹´ì–‘êµ°','ì˜ê´‘êµ°','ì¥ì„±êµ°','ì§„ë„êµ°','í•¨í‰êµ°'],
  'ê²½ìƒë¶ë„': ['í¬í•­ì‹œ','ê²½ì£¼ì‹œ','ê¹€ì²œì‹œ','ì•ˆë™ì‹œ','êµ¬ë¯¸ì‹œ','ì˜ì£¼ì‹œ','ì˜ì²œì‹œ','ìƒì£¼ì‹œ','ë¬¸ê²½ì‹œ','ê²½ì‚°ì‹œ','êµ°ìœ„êµ°','ì˜ì„±êµ°','ì²­ì†¡êµ°','ì˜ì–‘êµ°','ì˜ë•êµ°','ì²­ë„êµ°','ê³ ë ¹êµ°','ì„±ì£¼êµ°','ì¹ ê³¡êµ°','ì˜ˆì²œêµ°','ìš¸ì§„êµ°','ë´‰í™”êµ°','ìš¸ë¦‰êµ°'],
  'ê²½ìƒë‚¨ë„': ['ì°½ì›ì‹œ','ê¹€í•´ì‹œ','ì–‘ì‚°ì‹œ','ì§„ì£¼ì‹œ','í†µì˜ì‹œ','ì‚¬ì²œì‹œ','ê±°ì œì‹œ','ë°€ì–‘ì‹œ','í•¨ì•ˆêµ°','ê±°ì°½êµ°','í•©ì²œêµ°','ì°½ë…•êµ°','í•˜ë™êµ°','ì‚°ì²­êµ°','ë‚¨í•´êµ°','ì˜ë ¹êµ°','ê³ ì„±êµ°','í•¨ì–‘êµ°'],
  'ì œì£¼íŠ¹ë³„ìì¹˜ë„': ['ì œì£¼ì‹œ','ì„œê·€í¬ì‹œ']
};

/* ---------------- Init storage if absent ---------------- */
(function init(){
  if(!localStorage.getItem(K.USERS)) save(K.USERS, []);
  if(!localStorage.getItem(K.ITEMS)) save(K.ITEMS, []);
  if(!localStorage.getItem(K.REQS)) save(K.REQS, []);
  if(!localStorage.getItem(K.CHATS)) save(K.CHATS, []);
  if(!localStorage.getItem(K.PURCHASES)) save(K.PURCHASES, []);
  if(!localStorage.getItem(K.CHALLENGES)) save(K.CHALLENGES, [{id:'ch_week1', title:'ì´ë²ˆ ì£¼ 2ê±´ êµí™˜', target:2, reward:20}]);
})();

/* ---------------- App state ---------------- */
let users = load(K.USERS);
let items = load(K.ITEMS);
let requests = load(K.REQS);
let chats = load(K.CHATS);
let purchases = load(K.PURCHASES);
let challenges = load(K.CHALLENGES);
let currentUserId = localStorage.getItem('tt_current_user') || null;

/* ---------------- DOM refs ---------------- */
const sidoSelect = document.getElementById('sidoSelect');
const sigunSelect = document.getElementById('sigunSelect');
const grid = document.getElementById('grid');
const modalBackdrop = document.getElementById('modalBackdrop');
const modal = document.getElementById('modal');
const panel = document.getElementById('panel');

/* ---------------- Helpers ---------------- */
function persistAll(){ save(K.USERS, users); save(K.ITEMS, items); save(K.REQS, requests); save(K.CHATS, chats); save(K.PURCHASES, purchases); save(K.CHALLENGES, challenges); if(currentUserId) localStorage.setItem('tt_current_user', currentUserId); else localStorage.removeItem('tt_current_user'); }
function findUser(id){ return users.find(u=>u.id===id) || null; }
function findItem(id){ return items.find(i=>i.id===id) || null; }
function uidTime() { return Date.now(); }

/* ---------------- Populate region selects ---------------- */
function populateSido(){
  sidoSelect.innerHTML = '<option value="">ì‹œÂ·ë„ ì„ íƒ</option>';
  Object.keys(REGION).forEach(sido=>{
    const opt = document.createElement('option'); opt.value=sido; opt.textContent=sido; sidoSelect.appendChild(opt);
  });
  sidoSelect.addEventListener('change', ()=>{
    const s = sidoSelect.value;
    sigunSelect.innerHTML = '<option value="">ì‹œÂ·êµ°Â·êµ¬ ì„ íƒ</option>';
    if(s && REGION[s]) REGION[s].forEach(g=>{ const o = document.createElement('option'); o.value=g; o.textContent=g; sigunSelect.appendChild(o); });
    renderGrid();
  });
  sigunSelect.addEventListener('change', ()=> renderGrid());
}
populateSido();

/* ---------------- Modal open/close ---------------- */
function openModal(html){ modal.innerHTML = html; modalBackdrop.style.display = 'flex'; }
function closeModal(){ modalBackdrop.style.display = 'none'; }

/* click outside to close */
modalBackdrop.addEventListener('click', (e)=> { if(e.target === modalBackdrop) closeModal(); });

/* ---------------- Login / Register ---------------- */
document.getElementById('openProfileBtn').addEventListener('click', ()=> { if(!currentUserId) openLoginModal(); else openProfileModal(); });
function openLoginModal(){
  openModal(`<h3>ë¡œê·¸ì¸ / íšŒì›ë“±ë¡</h3>
    <div class="form-row"><input id="loginName" placeholder="ì´ë¦„"></div>
    <div class="form-row"><input id="loginSchool" placeholder="í•™êµ/ì§€ì—­"></div>
    <div class="form-actions"><button onclick="closeModal()">ì·¨ì†Œ</button><button id="doLoginBtn">ì €ì¥</button></div>`);
  document.getElementById('doLoginBtn').addEventListener('click', doLogin);
}
function doLogin(){
  const name = document.getElementById('loginName').value.trim();
  const school = document.getElementById('loginSchool').value.trim();
  if(!name || !school) return alert('ì´ë¦„ê³¼ í•™êµ/ì§€ì—­ì„ ì…ë ¥í•˜ì„¸ìš”.');
  users = load(K.USERS);
  let me = users.find(u=>u.name===name && u.school===school);
  if(!me){ me = { id: uid('u'), name, school, points: 50, trades:0, eco:0, created: uidTime() }; users.push(me); save(K.USERS, users); }
  currentUserId = me.id; localStorage.setItem('tt_current_user', currentUserId);
  persistAll(); closeModal(); renderPanel(); renderGrid(); alert(`${me.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`);
}
function openProfileModal(){
  const me = findUser(currentUserId);
  if(!me) return openLoginModal();
  let html = `<h3>ë‚´ í™œë™ â€” ${me.name}</h3><div class="small">í¬ì¸íŠ¸: ${me.points}P Â· ê±°ë˜: ${me.trades} Â· ëˆ„ì  ì ˆê°: ${me.eco.toFixed(2)} kg COâ‚‚</div><hr>`;
  html += `<h4>ë‚´ ë¬¼í’ˆ</h4>`;
  const myItems = items.filter(i=>i.ownerId===me.id);
  if(myItems.length===0) html += '<div class="small">ë“±ë¡í•œ ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>'; else myItems.forEach(it=> html += `<div style="padding:8px;border-bottom:1px solid #f4f4f4">${it.title} - ${it.status}</div>`);
  html += `<hr><h4>êµ¬ë§¤ ë‚´ì—­</h4>`;
  const myPurch = purchases.filter(p=>p.userId===me.id);
  if(myPurch.length===0) html += '<div class="small">êµ¬ë§¤ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; else myPurch.forEach(p=> html += `<div style="padding:6px">${p.title} - ${new Date(p.date).toLocaleString()}</div>`);
  html += `<div class="form-actions"><button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button><button onclick="closeModal()">ë‹«ê¸°</button></div>`;
  openModal(html);
}
function logout(){ currentUserId = null; localStorage.removeItem('tt_current_user'); renderPanel(); renderGrid(); closeModal(); alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.'); }

/* ---------------- Register item modal ---------------- */
document.getElementById('openRegisterBtn').addEventListener('click', ()=> openRegisterModal());
function openRegisterModal(){
  if(!currentUserId){ alert('ë“±ë¡í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.'); openLoginModal(); return; }
  let sidoOptions = '<option value="">ì‹œÂ·ë„ ì„ íƒ</option>';
  Object.keys(REGION).forEach(s=> sidoOptions += `<option value="${s}">${s}</option>`);
  openModal(`
    <h3>ë¬¼í’ˆ ë“±ë¡</h3>
    <div class="form-row"><input id="itemTitle" placeholder="ë¬¼í’ˆëª…"></div>
    <div class="form-row"><textarea id="itemDesc" rows="3" placeholder="ìƒì„¸ì„¤ëª…(ìƒíƒœ, ì‚¬ì´ì¦ˆ ë“±)"></textarea></div>
    <div class="form-row">
      <select id="itemCategory"><option>ì±…</option><option>ì˜ë¥˜</option><option>ì „ìê¸°ê¸°</option><option>ê¸°íƒ€</option></select>
      <select id="itemCondition"><option>ìµœìƒ</option><option>ì¢‹ìŒ</option><option>ë³´í†µ</option><option>ë‚¡ìŒ</option></select>
    </div>
    <div class="form-row">
      <input type="file" id="itemImage" accept="image/*">
      <div class="preview" id="imgPreview">ë¯¸ë¦¬ë³´ê¸°</div>
    </div>
    <div class="form-row">${sidoOptions}<select id="regSigun"><option value="">ì‹œÂ·êµ°Â·êµ¬ ì„ íƒ</option></select></div>
    <div class="form-actions"><button onclick="closeModal()">ì·¨ì†Œ</button><button id="doRegisterBtn">ë“±ë¡</button></div>
  `);
  const regSido = document.getElementById('itemImage'); // placeholder to avoid lint errors
  const selectSido = document.getElementById('itemCategory'); // placeholder
  // wire events
  const regSidoSel = Array.from(document.querySelectorAll('select')).find(s=>s.id==='itemCategory') ? null : null;
  // dynamic binding for region select inside modal:
  const modalSido = document.querySelector('#modal select#itemCategory') // not used, ignore
  // realistic approach: get elements by id via setTimeout to ensure DOM ready
  setTimeout(()=> {
    const sSel = document.getElementById('itemCategory'); // exists
    const regSidoEl = document.getElementById('itemCategory'); // dummy
    const sidoEl = document.querySelector('#modal select[id="itemCategory"]') // fallback
    // actual region select in modal:
    const regionSido = document.querySelector('#modal option') // dummy
    // proper elements:
    const realSido = document.getElementById('itemCategory'); // we will instead find regSido element by name: use regSidoSelect above
  }, 50);

  // Attach event handlers properly by selecting by id
  // (we created regSido & regSigun by id strings)
  // We need to fill regSigun when user chooses sido outside â€” we used sidoOptions in modal; but we didn't give id to that select â€” fix: access by querySelector
  // So simpler: populate regSido select by find select with innerHTML containing sidoOptions - find first select without id that matches
  const selects = modal.querySelectorAll('select');
  // The first select is itemCategory (we need to keep), but we placed sidoOptions as raw HTML, so the regSido select is the third row's first select; find the select with options that match REGION keys
  let regSidoSelect = null;
  selects.forEach(s=>{
    if(s.querySelector(`option[value="${Object.keys(REGION)[0]}"]`)) regSidoSelect = s;
  });
  const regSigun = modal.querySelector('#regSigun');
  if(regSidoSelect){
    regSidoSelect.addEventListener('change', ()=>{
      const v = regSidoSelect.value;
      regSigun.innerHTML = '<option value="">ì‹œÂ·êµ°Â·êµ¬ ì„ íƒ</option>';
      if(v && REGION[v]) REGION[v].forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; regSigun.appendChild(o); });
    });
  }
  const imgInput = modal.querySelector('#itemImage');
  const preview = modal.querySelector('#imgPreview');
  imgInput.addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{ preview.style.backgroundImage = `url(${reader.result})`; preview.style.backgroundSize='cover'; preview.textContent=''; preview.dataset.src = reader.result; };
    reader.readAsDataURL(f);
  });
  document.getElementById('doRegisterBtn').addEventListener('click', doRegisterItem);
}
function doRegisterItem(){
  const title = document.getElementById('itemTitle').value.trim();
  const desc = document.getElementById('itemDesc').value.trim();
  const category = document.getElementById('itemCategory').value;
  const condition = document.getElementById('itemCondition').value;
  // find region selects inside modal
  const regSido = Array.from(modal.querySelectorAll('select')).find(s=> Object.keys(REGION).includes(s.value));
  const regSigun = modal.querySelector('#regSigun');
  const sido = regSido ? regSido.value : '';
  const sigun = regSigun ? regSigun.value : '';
  const preview = document.getElementById('imgPreview');
  if(!title || !desc){ alert('ë¬¼í’ˆëª…ê³¼ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const image = preview.dataset.src || '';
  const it = { id: uid('it'), title, desc, category, condition, image, ownerId: currentUserId, sido, sigun, status:'available', carbon: calcCarbon(category, condition), created: Date.now() };
  items = load(K.ITEMS); items.unshift(it); save(K.ITEMS, items); persistAll();
  closeModal(); renderGrid(); renderPanel(); alert('ë¬¼í’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸŒ±');
}

/* ---------------- Render grid ---------------- */
function renderGrid(){
  users = load(K.USERS); items = load(K.ITEMS); requests = load(K.REQS); chats = load(K.CHATS);
  grid.innerHTML = '';
  const q = document.getElementById('searchInput').value.toLowerCase();
  const cat = document.getElementById('categoryFilter').value;
  const sido = document.getElementById('sidoSelect').value;
  const sigun = document.getElementById('sigunSelect').value;
  items.filter(it=>it.status==='available').forEach(it=>{
    if(cat && it.category !== cat) return;
    if(sido && it.sido !== sido) return;
    if(sigun && it.sigun !== sigun) return;
    if(q && !(it.title.toLowerCase().includes(q) || it.desc.toLowerCase().includes(q))) return;
    const owner = users.find(u=>u.id===it.ownerId) || {name:'ìµëª…'};
    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('img'); img.src = it.image || placeholder(it.category);
    const content = document.createElement('div'); content.className='card-content';
    const h3 = document.createElement('h3'); h3.textContent = it.title;
    const p = document.createElement('p'); p.textContent = it.desc;
    const meta = document.createElement('div'); meta.className='small'; meta.textContent = `${it.category} Â· ${it.sido||''}${it.sigun?('/'+it.sigun):''} Â· ì†Œìœ ì: ${owner.name}`;
    const footer = document.createElement('div'); footer.className='card-footer';
    const tag = document.createElement('div'); tag.className='tag'; tag.textContent = it.category;
    const btn = document.createElement('button'); btn.className='exchange-btn'; btn.textContent='êµí™˜ ì œì•ˆ';
    btn.onclick = ()=> openRequestModal(it.id);
    const chatBtn = document.createElement('button'); chatBtn.className='btn'; chatBtn.style.background='transparent'; chatBtn.style.border='1px solid #e6e6e6'; chatBtn.textContent='ì±„íŒ…';
    chatBtn.onclick = ()=> openOrCreateChat(it.id);
    footer.appendChild(tag); footer.appendChild(btn);
    content.appendChild(h3); content.appendChild(p); content.appendChild(meta); content.appendChild(footer);
    card.appendChild(img); card.appendChild(content);
    grid.appendChild(card);
  });
}

/* ---------------- placeholder ---------------- */
function placeholder(cat){ const map={'ì±…':'https://images.unsplash.com/photo-1512820790803-83ca734da794?auto=format&fit=crop&w=800&q=60','ì˜ë¥˜':'https://images.unsplash.com/photo-1520975910870-83f4a4c3b5f1?auto=format&fit=crop&w=800&q=60','ì „ìê¸°ê¸°':'https://images.unsplash.com/photo-1518779578993-ec3579fee39f?auto=format&fit=crop&w=800&q=60','ê¸°íƒ€':'https://images.unsplash.com/photo-1542291026-7eec264c27ff?auto=format&fit=crop&w=800&q=60'}; return map[cat]||map['ê¸°íƒ€']; }

/* ---------------- Request flow ---------------- */
function openRequestModal(itemId){
  if(!currentUserId){ alert('êµí™˜ ì œì•ˆí•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.'); openLoginModal(); return; }
  const it = findItem(itemId); if(!it) return alert('ë¬¼í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  if(it.ownerId === currentUserId) return alert('ë³¸ì¸ ë¬¼í’ˆì…ë‹ˆë‹¤.');
  const owner = findUser(it.ownerId);
  openModal(`<h3>êµí™˜ ì œì•ˆ â€” ${it.title}</h3><div class="small">ì†Œìœ ì: ${owner?owner.name:'-'}</div><div class="form-row"><textarea id="reqMsg" rows="3" placeholder="êµí™˜ ì œì•ˆ ë©”ì‹œì§€"></textarea></div><div class="form-actions"><button onclick="closeModal()">ì·¨ì†Œ</button><button id="sendReqBtn">ì œì•ˆ ë³´ë‚´ê¸°</button></div>`);
  document.getElementById('sendReqBtn').addEventListener('click', ()=> sendRequest(itemId));
}
function sendRequest(itemId){
  const message = document.getElementById('reqMsg').value.trim();
  const it = findItem(itemId);
  const req = { id: uid('req'), itemId, fromUserId: currentUserId, toUserId: it.ownerId, message, status:'pending', created: Date.now() };
  requests = load(K.REQS); requests.push(req); save(K.REQS, requests);
  // create chat thread or append
  chats = load(K.CHATS);
  let thread = chats.find(c=>c.itemId===itemId && c.participants.includes(currentUserId) && c.participants.includes(it.ownerId));
  if(!thread){ thread = { id: uid('ch'), itemId, topic: it.title, participants: [currentUserId, it.ownerId], messages: [] }; chats.push(thread); save(K.CHATS, chats); }
  thread.messages.push({ id: uid('m'), from: currentUserId, text: message || 'êµí™˜ ì œì•ˆí•©ë‹ˆë‹¤.', time: Date.now() });
  save(K.CHATS, chats); persistAll();
  closeModal(); renderPanel(); alert('êµí™˜ ì œì•ˆì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

/* ---------------- Respond to request (accept/reject) ---------------- */
function respondRequest(reqId, action){
  requests = load(K.REQS);
  const r = requests.find(x=>x.id===reqId); if(!r) return;
  if(action==='rejected'){ r.status='rejected'; save(K.REQS, requests); persistAll(); renderPanel(); alert('ê±°ì ˆ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); return; }
  if(action==='accepted'){
    r.status='accepted';
    items = load(K.ITEMS);
    const it = items.find(i=>i.id===r.itemId);
    if(!it){ alert('ì•„ì´í…œ ì—†ìŒ'); return; }
    it.status = 'traded';
    save(K.ITEMS, items);
    users = load(K.USERS);
    const proposer = users.find(u=>u.id===r.fromUserId);
    const owner = users.find(u=>u.id===r.toUserId);
    const carbonBonus = Math.round(it.carbon || 0);
    if(proposer){ proposer.points = (proposer.points||0) + 10 + carbonBonus; proposer.trades = (proposer.trades||0) + 1; proposer.eco = (proposer.eco||0) + (it.carbon||0); }
    if(owner){ owner.points = (owner.points||0) + 5 + Math.floor(carbonBonus/2); owner.trades = (owner.trades||0) + 1; owner.eco = (owner.eco||0) + (it.carbon||0); }
    save(K.USERS, users); save(K.REQS, requests); persistAll();
    // append chat message
    chats = load(K.CHATS);
    let thread = chats.find(c=>c.itemId===it.id && c.participants.includes(r.fromUserId) && c.participants.includes(r.toUserId));
    if(!thread){ thread = { id: uid('ch'), itemId: it.id, topic: it.title, participants: [r.fromUserId, r.toUserId], messages: [] }; chats.push(thread); }
    thread.messages.push({ id: uid('m'), from: r.toUserId, text:'ê±°ë˜ë¥¼ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!', time: Date.now() });
    save(K.CHATS, chats); persistAll();
    renderGrid(); renderPanel(); alert('ê±°ë˜ ì™„ë£Œ! í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
}
window.respondRequest = respondRequest;

/* ---------------- Chat UI ---------------- */
function openOrCreateChat(itemId){
  if(!currentUserId){ alert('ì±„íŒ…í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.'); openLoginModal(); return; }
  const it = findItem(itemId); if(!it) return;
  chats = load(K.CHATS);
  let thread = chats.find(c=> c.itemId===itemId && c.participants.includes(currentUserId));
  if(!thread){ thread = { id: uid('ch'), itemId, topic: it.title, participants: [currentUserId, it.ownerId], messages: [] }; chats.push(thread); save(K.CHATS, chats); }
  openChatModal(thread.id);
}
function openChatModal(threadId){
  const thread = load(K.CHATS).find(c=>c.id===threadId);
  if(!thread) return alert('ì±„íŒ… ì—†ìŒ');
  let html = `<h3>ì±„íŒ… â€” ${thread.topic}</h3><div id="chatBox" style="max-height:360px;overflow:auto;border:1px solid #f0f0f0;padding:8px;margin-bottom:8px">`;
  thread.messages.forEach(m=>{
    const from = findUser(m.from) || {name:'ìµëª…'};
    const side = (m.from === currentUserId) ? 'right' : 'left';
    html += `<div style="margin:6px 0;text-align:${side}"><div style="display:inline-block;background:${m.from===currentUserId? 'linear-gradient(135deg,var(--main-green),var(--light-green))':'#f4f4f4'};color:${m.from===currentUserId? '#fff':'#333'};padding:8px;border-radius:8px;max-width:80%;">${m.text}</div><div class="small" style="margin-top:4px">${from.name}</div></div>`;
  });
  html += `</div><div class="form-row"><input id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></div><div class="form-actions"><button onclick="closeModal()">ë‹«ê¸°</button><button id="sendChatBtn">ì „ì†¡</button></div>`;
  openModal(html);
  document.getElementById('sendChatBtn').addEventListener('click', ()=> {
    const txt = document.getElementById('chatInput').value.trim(); if(!txt) return;
    thread.messages.push({ id: uid('m'), from: currentUserId, text: txt, time: Date.now() });
    save(K.CHATS, load(K.CHATS)); persistAll();
    openChatModal(thread.id);
  });
}

/* ---------------- Shop purchase ---------------- */
const shopCatalog = [
  {id:'s_seed', title:'ì”¨ì•— í‚¤íŠ¸', price:30},
  {id:'s_sticker', title:'ìŠ¤í‹°ì»¤íŒ©', price:20},
  {id:'s_bag', title:'ë¦¬ìœ ì¦ˆ ì—ì½”ë°±', price:120},
  {id:'s_mug', title:'ì—ì½” ë¨¸ê·¸ì»µ', price:90},
  {id:'s_tumbler', title:'ëŒ€ë‚˜ë¬´ í…€ë¸”ëŸ¬', price:250},
  {id:'s_bottle', title:'ë¦¬ìœ ì €ë¸” ë¬¼ë³‘', price:150},
  {id:'s_tee', title:'ì—…ì‚¬ì´í´ í‹°ì…”ì¸ ', price:200},
  {id:'s_bamboo', title:'ëŒ€ë‚˜ë¬´ ì¹«ì†” ì„¸íŠ¸', price:35},
  {id:'s_planner', title:'ì¬ìƒ ì¢…ì´ í”Œë˜ë„ˆ', price:55},
  {id:'s_bag2', title:'ì¹œí™˜ê²½ ì¥ë°”êµ¬ë‹ˆ', price:40}
];
function buyShop(shopId){
  if(!currentUserId){ alert('êµ¬ë§¤í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.'); openLoginModal(); return; }
  const item = shopCatalog.find(s=>s.id===shopId);
  const usersList = load(K.USERS);
  const me = usersList.find(u=>u.id===currentUserId);
  if(!me) return;
  if(me.points < item.price) return alert('í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
  if(!confirm(`${item.title}ì„(ë¥¼) ${item.price}í¬ì¸íŠ¸ë¡œ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  me.points -= item.price;
  purchases.push({id: uid('p'), userId: me.id, shopId, title: item.title, date: Date.now()});
  save(K.PURCHASES, purchases); save(K.USERS, usersList); users = usersList; persistAll();
  alert('êµ¬ë§¤ ì™„ë£Œ! (ëª¨ì˜ ë°°ì†¡ì€ ë°°ì†¡ API ì—°ë™ ì‹œ í™œì„±í™”ë©ë‹ˆë‹¤.)');
  renderPanel();
}
window.buyShop = buyShop;

/* ---------------- Dashboard & ranking ---------------- */
function renderDashboard(){
  const traded = load(K.ITEMS).filter(i=>i.status==='traded');
  const totalCarbon = traded.reduce((s,it)=>s + (it.carbon||0), 0);
  const tradedCount = traded.length;
  const html = `<div class="dashboard" style="max-width:1000px;margin:20px auto;background:#fff;padding:12px;border-radius:12px;box-shadow:var(--card-shadow)">
    <h3>íƒ„ì†Œì ˆê° ëŒ€ì‹œë³´ë“œ</h3>
    <div style="display:flex;gap:16px;flex-wrap:wrap">
      <div style="flex:1;min-width:160px"><div class="small">ëˆ„ì  ì ˆê°ëŸ‰</div><div style="font-weight:800">${totalCarbon.toFixed(2)} kg COâ‚‚</div></div>
      <div style="flex:1;min-width:160px"><div class="small">ê±°ë˜ ê±´ìˆ˜</div><div style="font-weight:800">${tradedCount}ê±´</div></div>
      <div style="flex:1;min-width:160px"><div class="small">ì´ ì‚¬ìš©ì</div><div style="font-weight:800">${load(K.USERS).length}ëª…</div></div>
    </div></div>`;
  document.getElementById('dashboardArea').innerHTML = html; window.scrollTo({top:document.getElementById('dashboardArea').offsetTop, behavior:'smooth'});
}
document.getElementById('openDashboardQuick').addEventListener('click', ()=> renderDashboard());

function renderRanking(){
  users = load(K.USERS);
  const sorted = [...users].sort((a,b)=> (b.points||0) - (a.points||0));
  const el = document.getElementById('rankingList'); el.innerHTML='';
  sorted.slice(0,10).forEach((u,i)=>{ const d = document.createElement('div'); d.style.padding='6px 0'; d.innerHTML = `${i+1}. <strong>${u.name}</strong> <div class="small">${u.school||'-'}</div><div style="float:right;font-weight:700">${u.points||0}P</div>`; el.appendChild(d); });
}

/* ---------------- Panel render (notifications, chats, shop) ---------------- */
function renderPanel(){
  users = load(K.USERS); items = load(K.ITEMS); requests = load(K.REQS); chats = load(K.CHATS); challenges = load(K.CHALLENGES);
  const me = findUser(currentUserId);
  document.getElementById('avatar').textContent = me ? me.name.slice(0,2) : '?';
  document.getElementById('profileName').textContent = me ? me.name : 'ë¹„ë¡œê·¸ì¸';
  document.getElementById('profileSchool').textContent = me ? me.school : 'í•™êµ/ì§€ì—­ ì…ë ¥ í•„ìš”';
  document.getElementById('profilePoints').textContent = me ? (me.points||0) : 0;
  document.getElementById('profileTrades').textContent = me ? (me.trades||0) : 0;

  // notif
  const notifList = document.getElementById('notifList'); notifList.innerHTML = '';
  if(!me) notifList.innerHTML = '<div class="small">ë¡œê·¸ì¸í•˜ë©´ ì•Œë¦¼ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
  else {
    const mine = requests.filter(r=> r.toUserId===me.id && r.status==='pending');
    if(mine.length===0) notifList.innerHTML = '<div class="small">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    else mine.forEach(r=>{
      const from = findUser(r.fromUserId) || {name:'ìµëª…'}; const it = findItem(r.itemId) || {title:'[ì‚­ì œëœ ë¬¼í’ˆ]'};
      const div = document.createElement('div'); div.style.padding='8px'; div.style.border='1px dashed #eee'; div.style.marginBottom='8px';
      div.innerHTML = `<div style="font-weight:700">${from.name}</div><div class="small">${it.title}ì— ëŒ€í•œ êµí™˜ ì œì•ˆ</div>
        <div style="margin-top:8px;text-align:right"><button onclick="respondRequest('${r.id}','accepted')" class="btn">ìˆ˜ë½</button> <button onclick="respondRequest('${r.id}','rejected')">ê±°ì ˆ</button></div>`;
      notifList.appendChild(div);
    });
  }

  // chats
  const chatListEl = document.getElementById('chatList'); chatListEl.innerHTML = '';
  if(!me) chatListEl.innerHTML = '<div class="small">ë¡œê·¸ì¸í•˜ë©´ ì±„íŒ…ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
  else {
    const myThreads = chats.filter(c=> c.participants.includes(me.id));
    if(myThreads.length===0) chatListEl.innerHTML = '<div class="small">ì±„íŒ… ìŠ¤ë ˆë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    else myThreads.forEach(t=>{ const otherId = t.participants.find(p=>p!==me.id); const other = findUser(otherId) || {name:'ìµëª…'}; const el = document.createElement('div'); el.className='chat-item'; el.textContent = `${other.name} Â· ${t.topic}`; el.onclick = ()=> openChatModal(t.id); chatListEl.appendChild(el); });
  }

  // shop
  const shopEl = document.getElementById('shopList'); shopEl.innerHTML = '';
  shopCatalog.forEach(si=>{
    const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.marginBottom='8px';
    d.innerHTML = `<div><strong>${si.title}</strong><div class="small">${si.price}P</div></div><div><button onclick="buyShop('${si.id}')">êµ¬ë§¤</button></div>`;
    shopEl.appendChild(d);
  });

  renderRanking();
}

/* ---------------- Quick shop / modal controls ---------------- */
document.getElementById('openShopQuick').addEventListener('click', ()=> { openModal('<h3>í¬ì¸íŠ¸ ìƒì </h3><div id="quickShop"></div><div class="form-actions"><button onclick="closeModal()">ë‹«ê¸°</button></div>'); const quick=document.getElementById('quickShop'); shopCatalog.forEach((s,i)=>{ const b=document.createElement('div'); b.style.margin='8px 0'; b.innerHTML=`${s.title} - ${s.price}P <button onclick="buyShop('${s.id}')">êµ¬ë§¤</button>`; quick.appendChild(b); }); });
document.getElementById('panelToggle').addEventListener('click', ()=>{ panel.classList.toggle('open'); renderPanel(); });
document.getElementById('panelToggleBtn').addEventListener('click', ()=>{ panel.classList.toggle('open'); renderPanel(); });
document.getElementById('openChallenges').addEventListener('click', ()=> openChallengesModal());
document.getElementById('openRegisterBtn').addEventListener('click', ()=> openRegisterModal());

/* ---------------- Challenges ---------------- */
function openChallengesModal(){ let html = `<h3>ì±Œë¦°ì§€</h3><div style="max-height:60vh;overflow:auto">`; challenges.forEach(c=> html += `<div style="padding:8px;border-bottom:1px solid #f4f4f4"><strong>${c.title}</strong><div class="small">ë³´ìƒ ${c.reward}P Â· ëª©í‘œ ${c.target}ê±´</div><div style="margin-top:8px"><button onclick="claimChallenge('${c.id}')">ë³´ìƒ ë°›ê¸°</button></div></div>`); html += `</div><div class="form-actions"><button onclick="closeModal()">ë‹«ê¸°</button></div>`; openModal(html); }
function claimChallenge(id){ if(!currentUserId){ alert('ë¡œê·¸ì¸ í•„ìš”'); openLoginModal(); return; } const ch = challenges.find(c=>c.id===id); const me = findUser(currentUserId); if((me.trades||0)>=ch.target){ me.points = (me.points||0) + (ch.reward||0); save(K.USERS, users); persistAll(); renderPanel(); alert('ë³´ìƒ ì§€ê¸‰ ì™„ë£Œ!'); closeModal(); } else alert('ëª©í‘œ ë¯¸ë‹¬ì„±'); }

/* ---------------- Logout exposed ---------------- */
window.logout = logout;

/* ---------------- Initial render ---------------- */
renderGrid(); renderPanel(); renderDashboard();

/* ---------------- Search / filter bindings ---------------- */
document.getElementById('searchInput').addEventListener('input', ()=> renderGrid());
document.getElementById('categoryFilter').addEventListener('change', ()=> renderGrid());
document.getElementById('sidoSelect').addEventListener('change', ()=> renderGrid());
document.getElementById('sigunSelect').addEventListener('change', ()=> renderGrid());

/* ---------------- Expose some functions for console/testing ---------------- */
window.openRegisterModal = openRegisterModal;
window.openLoginModal = openLoginModal;
window.openChatModal = openChatModal;
window.renderGrid = renderGrid;
window.renderPanel = renderPanel;
window.renderDashboard = renderDashboard;
window.buyShop = buyShop;
window.findUser = findUser;
window.findItem = findItem;
</script>
</body>
</html>
